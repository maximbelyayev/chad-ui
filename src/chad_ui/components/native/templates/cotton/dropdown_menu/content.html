{% with component='dropdown-menu' %}

<c-vars align="center" alignOffset="0" side="bottom" sideOffset="5" />

<template x-teleport="body">
    <div x-data="{ 
            items: [],
            highlightedIndex: -1,
            align: '{{ align }}',
            alignOffset: {{ alignOffset }},
            side: '{{ side }}',
            sideOffset: {{ sideOffset }},
            anchor: null,
            initAnchor() {
                return Array.from(document.querySelectorAll(`[x-data][data-slot='${component}-trigger']`))
                    .find(n => { try { return Alpine.$data(n).id === id || Alpine.$data(n).handle === handle } catch { return false } });
            },
            initContent() {
                this.anchor = this.initAnchor()
            },
            init() {   
                this.initContent()
                this.$nextTick(() => this.$nextTick(() => this.items = this.indexItems()));
                this.$watch('open', open => {
                    if (open) { htmx.process($el); this.highlightedIndex = -1; }
                    else this.items.forEach(i => this.removeFocus(i))
                })
            },
            indexItems() {
                return Array.from($el.querySelectorAll(`[data-slot='${component}-item']`))
            },
            handleFocus(el) {
                const index = this.items.indexOf(el);
                if (index > -1) this.highlightedIndex = index;
                this.items.filter(i => i !== el).forEach(i => this.removeFocus(i));
                el.focus();
                el.setAttribute('tabindex', 0);
                el.setAttribute('data-highlighted', '')    
                getStore(true).lastFocusedEl = el;  
            },
            removeFocus(el) {
                el.blur();
                el.setAttribute('tabindex', -1);
                el.removeAttribute('data-highlighted')
            }        
        }"
        :id="`${id}-portal`"
        x-effect="if (trigger) anchor = trigger; if (open) $el.removeAttribute('aria-hidden');"
        @htmx:before:init.window="if ($event.target.contains(anchor)) this.anchor = anchor;"
        class="fixed inset-0 z-10 pointer-events-none overflow-clip"
    >
        <div
            x-cloak
            x-show="modal && open"
            x-transition:enter="transition-opacity ease-out duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition-opacity ease-in duration-150"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            aria-hidden="true"
            class="fixed inset-0 duration-100 isolate bg-black/10 supports-backdrop-filter:backdrop-blur-xs"
            :class="openedOnHover ? 'pointer-events-none' : 'pointer-events-auto'"
        ></div>
        <div
            x-anchor.{{ side }}{% if align != 'center' %}-{{ align }}{% endif %}.offset.{{ sideOffset }}="anchor"
            style="transform: translate({% if side == 'right' or side == 'left'%}0,{{ alignOffset }}px{% else %}{{ alignOffset }}px,0{% endif %});"
            class="pointer-events-none"
        >
            <div
                x-show="open"
                :data-open="open ? '' : null"
                :data-closed="open ? null : ''"
                @click.away="open = false;"
                @keydown.down.prevent="if (items.length === 0) return;
                    if (highlightedIndex === -1) highlightedIndex = 0;
                    else if (highlightedIndex === items.length - 1) {
                        if (!loopFocus) return;
                        highlightedIndex = 0;
                    } else highlightedIndex++;
                    handleFocus(items[highlightedIndex]);
                "
                @keydown.up.prevent="if (items.length === 0) return;
                    if (highlightedIndex === -1) highlightedIndex = items.length - 1;
                    else if (highlightedIndex === 0) {
                        if (!loopFocus) return;
                        highlightedIndex = items.length - 1;
                    } else highlightedIndex--;
                    handleFocus(items[highlightedIndex]);
                "
                @mouseenter="hoverCloseTimeout = destroyTimeout(hoverCloseTimeout)"
                @mouseleave="if (openedOnHover && trigger) {
                    triggerData = Alpine.$data(trigger)
                    hoverCloseTimeout = destroyTimeout(hoverCloseTimeout);
                    createHoverCloseTimeout($el, $event, triggerData.closeDelay);
                }"
                x-trap="open && trap"
                x-transition:enter="transition-all ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95 {% if side == 'bottom' %}-translate-y-2{% elif side == 'top' %}translate-y-2{% elif side == 'left' %}translate-x-2{% elif side == 'right' %}-translate-x-2{% endif %}"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition-all ease-in duration-150"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
                tabindex="-1"
                role="menu"
                data-slot="{{ component }}-content"
                class="pointer-events-auto ring-foreground/10 bg-popover text-popover-foreground min-w-32 rounded-md p-1 shadow-md ring-1 duration-100 overflow-x-hidden overflow-y-auto outline-none data-closed:overflow-hidden{% if class %} {{ class }}{% endif %}"
                {{ attrs }}
            >
                {{ slot }}
            </div>
        </div>
    </div>
</template>

{% endwith %}