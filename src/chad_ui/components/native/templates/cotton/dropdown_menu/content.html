{% with component='dropdown-menu' %}

<c-vars align="center" alignOffset="0" side="bottom" sideOffset="5" />

<template x-teleport="body">
    <div x-data="{ 
            items: [],
            highlightedIndex: -1,

            anchor: null,
            initAnchor() {
                return Array.from(document.querySelectorAll(`[x-data][data-slot='${component}-trigger']`))
                    .find(n => { try { return Alpine.$data(n).id === id || Alpine.$data(n).handle === handle } catch { return false } });
            },
            initContent() {
                this.anchor = this.initAnchor()
            },
            init () {
                this.initContent()
                this.$nextTick(() => {
                    this.$nextTick(() => {
                        this.items = this.indexItems()
                    });
                })
                this.$watch('open', open => {
                    if (open) {
                        this.highlightedIndex = -1;
                    }
                    else {
                        this.items.forEach(i => this.removeFocus(i));
                    }
                })
            },
            indexItems() {
                return Array.from($el.querySelectorAll(`[x-data][data-slot='${component}-item']`))
            },
            handleFocus(el) {
                this.items.filter(i => i !== el).forEach(i => this.removeFocus(i));
                el.focus();
                el.setAttribute('tabindex', 0);
                el.setAttribute('data-highlighted', '')                
            },
            removeFocus(el) {
                el.blur();
                el.setAttribute('tabindex', -1);
                el.removeAttribute('data-highlighted')
            }        
        }"
        :id="id"
        x-effect="
            if (trigger) anchor = trigger;
            if (open) $el.removeAttribute('aria-hidden');
        "   
    >
        <div
            x-cloak
            x-show="modal && open"
            x-transition:enter="transition-opacity ease-out duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition-opacity ease-in duration-150"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            aria-hidden="true"
            class="fixed inset-0 z-50 duration-100 isolate bg-black/10 supports-backdrop-filter:backdrop-blur-xs"
        ></div>
        <div
            x-anchor.{{ side }}{% if align != 'center' %}-{{ align }}{% endif %}.offset.{{ sideOffset }}="anchor"
            style="transform: translate({% if side == 'right' or side == 'left'%}0,{{ alignOffset }}px{% else %}{{ alignOffset }}px,0{% endif %});"
            class="z-50"
        >
            <div
                x-show="open"
                x-watch
                :id="$id(`chad-ui_${component}-content_r`)"
                :data-open="open ? '' : null"
                :data-closed="open ? null : ''"
                @click.away="open = false"
                @keydown.down.prevent="
                highlightedIndex = highlightedIndex === -1
                    ? 0
                    : (highlightedIndex + 1) % items.length;
                handleFocus(items[highlightedIndex]);
                "
                @keydown.up.prevent="
                highlightedIndex = highlightedIndex === -1
                    ? items.length - 1
                    : (highlightedIndex - 1 + items.length) % items.length;
                handleFocus(items[highlightedIndex]);
                "
                @mouseenter="
                    if (hoverCloseTimeout) {
                        clearTimeout(hoverCloseTimeout)
                        hoverCloseTimeout = null;
                    }
                "
                @mouseleave="
                    if (openedOnHover && trigger) {
                        const triggerData = Alpine.$data(trigger)
                        if (hoverCloseTimeout) clearTimeout(hoverCloseTimeout);
                        const event = $event;
                        hoverCloseTimeout = setTimeout(() => {
                            triggerData.handleTrigger(event);
                            openedOnHover = false;
                            hoverCloseTimeout = null;
                        }, 100);
                    }
                "
                x-trap="open"
                x-transition:enter="transition-all ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95 {% if side == 'bottom' %}-translate-y-2{% elif side == 'top' %}translate-y-2{% elif side == 'left' %}translate-x-2{% elif side == 'right' %}-translate-x-2{% endif %}"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition-all ease-in duration-150"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
                tabindex="-1"
                role="menu"
                data-slot="{{ component }}-content"
                class="
                ring-foreground/10 bg-popover text-popover-foreground min-w-32 rounded-md p-1 shadow-md ring-1 duration-100 z-50 
                overflow-x-hidden overflow-y-auto outline-none data-closed:overflow-hidden
                {% if class %}
                    {{ class }}
                {% endif %}
                "
                {{ attrs }}
            >
                {{ slot }}
            </div>
        </div>
    </div>
</template>

{% endwith %%}