{% with component='dropdown-menu' %}

<c-vars handle="show-{{ component }}" asChild openOnHover/>

<div data-slot="{{ component }}-trigger"
    x-data="{
        handle: '{{ handle }}',
        disabled: {{ disabled|yesno:'true,false' }},
        openOnHover: {{ openOnHover|yesno:'true,false' }},
        asChild: {{ asChild|yesno:'true,false' }},
        
        component: '{{ component }}',
        root: null,
        detached: null,
        findRoot() {
            const p = this.$el.parentElement;
            if (p.getAttribute('data-slot') === this.component) return p;
            return Array.from(document.querySelectorAll(`[x-data][data-slot='${this.component}']`))
                .find(n => { try { return Alpine.$data(n).handle === this.handle } catch { return false } });
        },
        initTrigger() {
            const r = this.findRoot();
            if (this.asChild && r) {
                const rData = Alpine.$data(r);
                if (typeof rData.initAsChild === 'function' && rData.initAsChild(this.$el)) return true;
            }
            this.root = r;
            this.detached = (r !== this.$el.parentElement);
            return false;
        },
        init () {
            this.$nextTick(() => {
                if (this.initTrigger()) return;
            });
        },
        handleTrigger(event) {
            if (this.disabled) return;
            const trigger = (document.activeElement && $el.contains(document.activeElement)) ? document.activeElement : $el;
            trigger.blur();
            const content = event.target.closest('[data-slot=dropdown-content]');
            if (content) { content.removeAttribute('aria-hidden'); }
            if (!this.detached) toggleMenu(event);
            else if (this.root) $dispatch(this.handle)
            else console.warn('[chad-ui] dropdown-menu: detached trigger has invalid or missing `handle`.');
        }
    }"
    :id="$id('chad-ui_{{ component }}-trigger_r')"
    @click="
        if (!root) { 
            handleTrigger($event); 
            return; 
        }
        
        const rootData = Alpine.$data(root);
        
        // Cancel any pending hover open (scenario 0.b)
        if (rootData.hoverOpenTimeout) {
            clearTimeout(rootData.hoverOpenTimeout);
            rootData.hoverOpenTimeout = null;
        }
        
        // Cancel any pending hover close
        if (rootData.hoverCloseTimeout) {
            clearTimeout(rootData.hoverCloseTimeout);
            rootData.hoverCloseTimeout = null;
        }
        
        // If opened via hover, convert to click-open (scenario 0.a)
        if (rootData.openedOnHover) {
            rootData.openedOnHover = false;
        }
        
        handleTrigger($event);
    "
    @mouseenter="
        if (!openOnHover || !root) return;
        const rootData = Alpine.$data(root);

        if (rootData.open && !rootData.openedOnHover) return;

        if (rootData.openedOnHover && rootData.trigger === $el) {
            if (rootData.hoverCloseTimeout) {
                clearTimeout(rootData.hoverCloseTimeout);
                rootData.hoverCloseTimeout = null;
            }
            return;
        };
        if (rootData.hoverOpenTimeout) clearTimeout(rootData.hoverOpenTimeout);
        const event = $event;
        rootData.hoverOpenTimeout = setTimeout(() => {
            handleTrigger(event);
            rootData.trigger = $el;
            rootData.openedOnHover = true;
            rootData.hoverOpenTimeout = null;
        }, 200);
    "
    @mouseleave="
        if (!root) return;
        const rootData = Alpine.$data(root);
        if (rootData.hoverOpenTimeout) {
            clearTimeout(rootData.hoverOpenTimeout)
            rootData.hoverOpenTimeout = null;
        }
        if (rootData.openedOnHover) {
            const event = $event;
            rootData.hoverCloseTimeout = setTimeout(() => {
                const triggerData = Alpine.$data(rootData.trigger);
triggerData.handleTrigger(event);
                rootData.openedOnHover = false;
                rootData.hoverCloseTimeout = null;
            }, 100);
        }
    "
    type="button"
    tabindex="0"
    aria-haspopup="menu"
    class="outline-hidden w-fit{% if class %} {{ class }}{% endif %}" 
    {{ attrs }}
>
    {{ slot }}
</div>

{% endwith %}