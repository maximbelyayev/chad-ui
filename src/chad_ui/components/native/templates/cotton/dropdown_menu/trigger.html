{% with component='dropdown-menu' %}
{% firstof handle 'handle-'|add:component as handle %}

<c-vars handle openOnHover delay="100" closeDelay="0" asChild />

<div data-slot="{{ component }}-trigger"
    x-data="{
        handle: '{{ handle }}',
        disabled: {{ disabled|yesno:'true,false' }},
        openOnHover: {{ openOnHover|yesno:'true,false' }},
        delay: {{ delay }},
        closeDelay: {{ closeDelay }},
        asChild: {{ asChild|yesno:'true,false' }},
        component: '{{ component }}',
        root: null,
        detached: null,
        id: '{{ attrs.id }}',
        findRoot() {
            const p = this.$el.parentElement;
            if (p.getAttribute('data-slot') === this.component) return p;
            return Array.from(document.querySelectorAll(`[x-data][data-slot='${this.component}']`))
                .find(n => { try { return Alpine.$data(n).handle === this.handle; } catch { return false; } });
        },
        initTrigger() {
            const r = this.findRoot();
            if (this.asChild && r) {
                const rData = Alpine.$data(r);
                if (typeof rData.initAsChild === 'function' && rData.initAsChild(this.$el)) return true;
            }
            this.root = r;
            this.detached = (r !== this.$el.parentElement);
            if (!this.id) this.id = $id(`${r.id}-trigger`) || $id(`chad-ui_r_${this.component}-trigger`);
            return false;
        },
        init() {
            this.$nextTick(() => {
                if (this.initTrigger()) return;
            });
        },
        handleTrigger(event) {
            if (this.disabled) return;
            const trigger = (document.activeElement && $el.contains(document.activeElement)) ? document.activeElement : $el;
            trigger.blur();
            const content = event.target.closest(`[data-slot=${this.component}-content]`);
            if (content) { content.removeAttribute('aria-hidden'); }
            if (!this.detached) toggleMenu(event);
            else if (this.root) $dispatch(this.handle);
            else console.warn(`[chad-ui] ${this.component}: detached trigger has invalid or missing handle.`);
        }
    }"
    :id="id"
    @click="
        const rootData = Alpine.$data(root);
        rootData.hoverOpenTimeout = rootData.destroyTimeout(rootData.hoverOpenTimeout);
        rootData.hoverCloseTimeout = rootData.destroyTimeout(rootData.hoverCloseTimeout);
        if (rootData.openedOnHover) rootData.openedOnHover = false;
        handleTrigger($event);
    "
    @mouseenter="
        if (!openOnHover || !root) return;
        const rootData = Alpine.$data(root);
        if (rootData.open && !rootData.openedOnHover) return;
        if (rootData.openedOnHover && rootData.trigger === $el) {
            rootData.hoverCloseTimeout = rootData.destroyTimeout(rootData.hoverCloseTimeout);
            return;
        }
        rootData.createHoverOpenTimeout($el, $event, delay);
    "
    @mouseleave="
        if (!root) return;
        const rootData = Alpine.$data(root);
        rootData.hoverOpenTimeout = rootData.destroyTimeout(rootData.hoverOpenTimeout);
        if (rootData.openedOnHover) rootData.createHoverCloseTimeout($el, $event, delay);
    "
    type="button"
    tabindex="0"
    aria-haspopup="menu"
    class="{% if class %}{{ class }}{% endif %}" 
    {{ attrs }}
>
    {{ slot }}
</div>

{% endwith %}