<c-vars defaultOpen disablePointerDismissal disableDismissalDuringHtmx handle="show-dialog" forceOverlay />

<div
    x-data="{
        id: '{{ attrs.id }}',
        open: {{ defaultOpen|yesno:'true,false' }},
        disablePointerDismissal: {{ disablePointerDismissal|yesno:'true,false' }},
        disableDismissalDuringHtmx: {{ disableDismissalDuringHtmx|yesno:'true,false' }},
        handle: '{{ handle }}',
        forceOverlay: {{ forceOverlay|yesno:'true,false' }},
        nestedIndex: null,
        htmxAwaitingResponse: false,
        eventTrigger: null,
        hideDialogHandler: null,

        showDialog(event) {
            this.nestedIndex = this.getStore().maxIndex = this.getOpenDialogCount();
            this.eventTrigger = event?.detail?.eventTrigger;
            document.body.classList.add('overflow-hidden');
            this.open = true;
        },
        hideDialog() {
            if (this.htmxAwaitingResponse && this.disableDismissalDuringHtmx) return;
            if (this.hasHtmx(this.eventTrigger)) {
                const dialogContent = document.querySelector(`#${this.id} [data-slot=dialog-content]`);
                if (dialogContent) {
                    setTimeout(() => {
                        dialogContent.querySelectorAll(':scope > :not([data-slot=dialog-close])').forEach(el => el.remove());
                    }, 100);
                }
            }
            this.open = false;
            this.eventTrigger = null;
            setTimeout(() => {
                this.nestedIndex = null;
                this.getStore().maxIndex = this.getOpenDialogCount() - 1;
            }, 100);
        },
        getOpenDialogCount() {
            return document.querySelectorAll('[data-slot=dialog-content][data-open]').length;
        },
        hasHtmx(el) {
            if (!el) return false;
            const htmxAttrs = ['hx-get', 'hx-post', 'hx-put', 'hx-patch', 'hx-delete'];
            return htmxAttrs.some(attr => 
                el.hasAttribute(attr) || el.querySelector(`[${attr}]`)
            );
        },
        initStore() {
            this.$store['chad-ui'] ??= {};
            this.$store['chad-ui'].dialog ??= {};
        },
        getStore() {
            return this.$store['chad-ui'].dialog;
        },
        init() {
            this.initStore();
            if (!this.id) this.id = $id('chad-ui_dialog_r');
            if (this.open) this.showDialog();
        },
    }"
    @{{ handle }}.window="open ? hideDialog() : showDialog($event)"
    @hide-dialog.window="if (open && (!$event.detail || !$event.detail.handle || $event.detail.handle === handle)) hideDialog()"
    @keydown.escape.window="if (open && (nestedIndex === getStore().maxIndex)) {
        $event.preventDefault();
        $event.stopImmediatePropagation();
        hideDialog();
    }"
    x-id="['chad-ui_dialog-title_r', 'chadui_dialog-description_r']"
    data-slot="dialog"
>   
    {{ slot }}
</div>