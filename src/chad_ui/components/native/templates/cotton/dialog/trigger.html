{% with component='dialog' %}
{% firstof handle 'handle-'|add:component as handle %}

<c-vars handle asChild />

<div data-slot="{{ component }}-trigger"
    x-data="{
        handle: '{{ handle }}',
        disabled: {{ disabled|yesno:'true,false' }},
        asChild: {{ asChild|yesno:'true,false' }},
        component: '{{ component }}',
        root: null,
        detached: null,
        id: '{{ attrs.id }}',
        findRoot() {
            const p = this.$el.parentElement;
            if (p.getAttribute('data-slot') === this.component) return p;
            return Array.from(document.querySelectorAll(`[x-data][data-slot='${this.component}']`))
                .find(n => { try { return Alpine.$data(n).handle === this.handle; } catch { return false; } });
        },
        initTrigger() {
            const r = this.findRoot();
            if (this.asChild && r) {
                const rData = Alpine.$data(r);
                if (typeof rData.initAsChild === 'function' && rData.initAsChild(this.$el)) return true;
            }
            this.root = r;
            this.detached = (r !== this.$el.parentElement);
            if (!this.id) this.id = $id(`${r.id}-trigger`) || $id(`chad-ui_r_${this.component}-trigger`);
            return false;
        },
        init() {
            this.$nextTick(() => {
                if (this.initTrigger()) return;
            });
        },
        handleTrigger(event) {
            if (this.disabled) return;
            const trigger = (document.activeElement && $el.contains(document.activeElement)) ? document.activeElement : $el;
            trigger.blur();
            const content = event.target.closest(`[data-slot=${this.component}-content]`);
            if (content) { content.removeAttribute('aria-hidden'); }
            if (!this.detached) showDialog(event);
            else if (this.root) $dispatch(this.handle)
            else console.warn(`[chad-ui] ${this.component}: detached trigger has invalid or missing handle.`);
        }
    }"
    @click="handleTrigger($event);"
    aria-haspopup="dialog"
    {{ attrs }}    
>
    {{ slot }}
</div>

{% endwith %}